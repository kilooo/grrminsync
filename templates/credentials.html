{% extends "base.html" %}

{% block content %}
<h1>Configuration</h1>
<p style="color: #64748b;">Manage external service connections.</p>

<!-- Garmin Card -->
<div class="card">
    <h2>Garmin Connect</h2>
    <p>Required for uploading weight data.</p>
    <div class="input-group">
        <label style="display:block; margin-bottom:5px; font-weight:500;">Email</label>
        <input type="email" id="garmin-email" placeholder="Garmin Email">
    </div>
    <div class="input-group">
        <label style="display:block; margin-bottom:5px; font-weight:500;">Password</label>
        <input type="password" id="garmin-password" placeholder="Garmin Password">
    </div>
    <div class="input-group" id="garmin-mfa-group" style="display:none; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px;">
        <label style="display:block; margin-bottom:5px; font-weight:500; color: #d97706;">2FA Code Required</label>
        <div style="display:flex; gap: 10px;">
            <input type="text" id="garmin-mfa-code" placeholder="Enter Code received via Email/SMS" style="flex:1;">
        </div>
        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Garmin requires verification. Check your email or SMS.</p>
    </div>
    <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
        <button id="garmin-btn" class="btn btn-secondary" onclick="saveGarminConfig()">Save Credentials</button>
        <span id="garmin-feedback" style="font-weight: bold;"></span>
    </div>
</div>

<!-- Withings Card -->
<div class="card">
    <h2>Withings API</h2>
    <p>Required for downloading weight data.</p>
    <div id="withings-status" style="margin-bottom: 20px; font-weight: 500; font-family: monospace;">Status: Checking...
    </div>

    <div class="input-group">
        <label style="display:block; margin-bottom:5px; font-weight:500;">Client ID</label>
        <input type="text" id="withings-id" placeholder="Copy from Withings Portal">
    </div>
    <div class="input-group">
        <label style="display:block; margin-bottom:5px; font-weight:500;">Client Secret</label>
        <input type="password" id="withings-secret" placeholder="Copy from Withings Portal">
    </div>

    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <button class="btn btn-secondary" onclick="saveWithingsConfig()">Save Credentials</button>
        <span id="withings-feedback" style="font-weight: bold;"></span>
        <button class="btn" style="background-color: #0ea5e9;"
            onclick="window.location.href='/auth/withings/login'">Connect Withings</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function saveGarminConfig() {
        const email = document.getElementById('garmin-email').value;
        const pass = document.getElementById('garmin-password').value;
        const mfaInput = document.getElementById('garmin-mfa-code');
        const mfaGroup = document.getElementById('garmin-mfa-group');
        const feedback = document.getElementById('garmin-feedback');
        const btn = document.getElementById('garmin-btn');

        // Basic validation
        if (!email) {
            feedback.innerHTML = '<span style="color:red;">❌ Email required</span>';
            setTimeout(() => feedback.innerHTML = '', 3000);
            return;
        }
        
        // If MFA hidden, password is required. 
        if (mfaGroup.style.display === 'none' && !pass) {
             feedback.innerHTML = '<span style="color:red;">❌ Password required</span>';
             setTimeout(() => feedback.innerHTML = '', 3000);
             return;
        }

        const formData = new FormData();
        formData.append('email', email);
        formData.append('password', pass);
        
        // Use MFA code if visible
        if (mfaGroup.style.display !== 'none' && mfaInput.value) {
             formData.append('mfa_code', mfaInput.value);
        }

        feedback.innerHTML = '<span style="color:blue;">⏳ Connecting...</span>';
        btn.disabled = true;

        fetch('/config/garmin', {
            method: 'POST',
            body: formData
        })
            .then(r => r.json().then(data => ({status: r.status, body: data})))
            .then(({status, body}) => {
                btn.disabled = false;
                if (status === 200) {
                     if (body.mfa_required) {
                         feedback.innerHTML = '<span style="color:#d97706;">⚠️ 2FA Code Required</span>';
                         mfaGroup.style.display = 'block';
                         mfaInput.focus();
                         btn.innerText = "Verify Code";
                     } else {
                         // Success
                         feedback.innerHTML = '<span style="color:green;">✅ Saved & Connected!</span>';
                         mfaGroup.style.display = 'none';
                         mfaInput.value = '';
                         btn.innerText = "Save Credentials";
                         setTimeout(() => feedback.innerHTML = '', 3000);
                     }
                } else {
                    feedback.innerHTML = `<span style="color:red;">❌ ${body.message}</span>`;
                }
            })
            .catch(err => {
                btn.disabled = false;
                feedback.innerHTML = `<span style="color:red;">❌ Error: ${err}</span>`;
            });
    }

    function saveWithingsConfig() {
        const id = document.getElementById('withings-id').value;
        const secret = document.getElementById('withings-secret').value;
        const feedback = document.getElementById('withings-feedback');

        if (!id || !secret) {
            feedback.innerHTML = '<span style="color:red;">❌ Client ID and Secret required</span>';
            setTimeout(() => feedback.innerHTML = '', 3000);
            return;
        }

        const formData = new FormData();
        formData.append('client_id', id);
        formData.append('client_secret', secret);

        fetch('/config/withings', {
            method: 'POST',
            body: formData
        })
            .then(r => {
                if (r.ok) {
                    return r.json().then(data => {
                        feedback.innerHTML = '<span style="color:green;">✅ Saved!</span>';
                        document.getElementById('withings-secret').value = '';
                        setTimeout(() => feedback.innerHTML = '', 3000);
                    });
                } else {
                    return r.json().then(data => {
                        feedback.innerHTML = `<span style="color:red;">❌ ${data.message}</span>`;
                        setTimeout(() => feedback.innerHTML = '', 3000);
                    });
                }
            })
            .catch(err => {
                feedback.innerHTML = `<span style="color:red;">❌ Error: ${err}</span>`;
                setTimeout(() => feedback.innerHTML = '', 3000);
            });
    }

    // Check status logic - Reuse existing endpoint if available or infer
    // For now we just check if token file exists but client-side can't see that directly.
    // We'll leave status as "Unknown" or implement a check endpoint later.
    document.getElementById('withings-status').innerText = 'Status: Ready to Connect';
</script>
{% endblock %}