{% extends "base.html" %}

{% block content %}
<h1>Dashboard</h1>
<p style="color: #64748b;">Manage your daily sync operations.</p>

<!-- Recent History Card -->
<div class="card">
    <h2>Recent Sync History</h2>
    <table
        style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <thead>
            <tr style="background-color: #f1f5f9; text-align: left;">
                <th style="padding: 12px 15px; border-bottom: 1px solid #ddd;">Time</th>
                <th style="padding: 12px 15px; border-bottom: 1px solid #ddd;">Status</th>
                <th style="padding: 12px 15px; border-bottom: 1px solid #ddd;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in history %}
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 12px 15px;">{{ entry.timestamp }}</td>
                <td
                    style="padding: 12px 15px; color: {{ 'green' if 'Success' in entry.status else 'red' }}; font-weight: bold;">
                    {{ entry.status }}
                </td>
                <td style="padding: 12px 15px;">
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;"
                        onclick="toggleLog(this, {{ loop.index }})">Show Log</button>
                </td>
            </tr>
            <tr id="log-row-{{ loop.index }}" style="display:none; background-color: #f8fafc;">
                <td colspan="3" style="padding: 0;">
                    <div
                        style="background: #1e293b; color: #cbd5e1; padding: 15px; margin: 0; font-family: monospace; font-size: 13px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
                        {{ entry.log }}</div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3" style="text-align:center; padding: 20px;">No history yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="margin-top: 15px; text-align: right;">
        <a href="/history" style="text-decoration: none; color: #2563eb; font-weight: 500;">View Full History →</a>
    </div>
</div>

<!-- Manual Sync Card -->
<div class="card">
    <h2>Manual Sync</h2>
    <p>Trigger an immediate synchronization of today's weight data.</p>
    <button class="btn" onclick="triggerSync()">Sync Now</button>
    <div id="status"
        style="margin-top: 15px; white-space: pre-wrap; text-align: left; background: #f1f5f9; padding: 15px; border-radius: 8px; display: none; font-family: monospace; font-size: 14px; overflow-x: auto; color: #333;">
    </div>
</div>

<!-- Auto-Sync Card -->
<div class="card">
    <h2>Auto-Sync Schedule</h2>
    <div id="schedule-status" style="margin-bottom: 20px; font-weight: 600; color: #475569;">Loading schedule...</div>

    <div class="input-group" style="display: flex; align-items: center; gap: 10px;">
        <label>Time (Local):</label>
        <input type="time" id="sched-time" style="width: auto;">
    </div>

    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn" onclick="setSchedule()">Set Daily Schedule</button>
        <button class="btn btn-danger" onclick="disableSchedule()">Disable Schedule</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function toggleLog(btn, index) {
        var row = document.getElementById('log-row-' + index);
        if (row.style.display === 'none') {
            row.style.display = 'table-row';
            btn.textContent = 'Hide Log';
        } else {
            row.style.display = 'none';
            btn.textContent = 'Show Log';
        }
    }

    function triggerSync() {
        const statusDiv = document.getElementById('status');
        statusDiv.style.display = 'block';
        statusDiv.innerText = 'Starting sync... please wait...';

        fetch('/sync', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                statusDiv.innerText = data.output;
            })
            .catch(error => {
                statusDiv.innerText = 'Error: ' + error;
            });
    }

    function updateScheduleDisplay() {
        fetch('/schedule')
            .then(r => r.json())
            .then(data => {
                const el = document.getElementById('schedule-status');
                if (data.enabled) {
                    // Server sends Local hour/minute.
                    const h = data.hour;
                    const m = data.minute;
                    const tz = data.timezone || 'Unknown';

                    // Format for display (AM/PM)
                    // We construct a date just for formatting, but we treat the hour/minute as local
                    const date = new Date();
                    date.setHours(h);
                    date.setMinutes(m);

                    const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    el.innerText = `✅ Scheduled daily at ${timeStr} (${tz})`;
                    el.style.color = 'green';

                    // Format for input (HH:mm 24-hour format required for input type="time")
                    const localH = String(h).padStart(2, '0');
                    const localM = String(m).padStart(2, '0');
                    document.getElementById('sched-time').value = `${localH}:${localM}`;
                } else if (!data.enabled && data.timezone) {
                    el.innerText = `❌ No schedule set (Server Timezone: ${data.timezone})`;
                    el.style.color = '#ef4444';
                } else {
                    el.innerText = '❌ No schedule set';
                    el.style.color = '#ef4444';
                }
            });
    }

    function setSchedule() {
        const timeInput = document.getElementById('sched-time').value;

        if (!timeInput) { alert('Invalid time'); return; }

        const [h, m] = timeInput.split(':').map(Number);

        // Send as-is (Local Server Time)
        fetch('/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hour: h, minute: m })
        })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                updateScheduleDisplay();
            });
    }

    function disableSchedule() {
        fetch('/schedule', { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                updateScheduleDisplay();
            });
    }

    // Load initial state
    updateScheduleDisplay();
</script>
{% endblock %}